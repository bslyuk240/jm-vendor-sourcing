
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JulineMart Vendor Sourcing</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#5E0063">
  <style>
    :root {
      --purple:#5E0063; --purple-dark:#3A003C; --purple-darker:#240025;
      --orange:#ff914d; --white:#ffffff; --ink:#f9fafb; --muted:#d1d5db;
      --pad:14px; --radius:14px;
    }
    *{ box-sizing:border-box }
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0;
      background: radial-gradient(1200px 700px at 20% -10%, var(--purple) 0%, var(--purple-dark) 45%, var(--purple-darker) 100%);
      color:var(--ink);
    }
    .topbar{ background:rgba(255,255,255,.06); backdrop-filter: blur(8px); color:#fff; padding:10px var(--pad); display:flex; align-items:center; justify-content:space-between; position: sticky; top: 0; z-index: 10; border-bottom:1px solid rgba(255,255,255,.08); }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800 }
    .brand img{ width:36px; height:36px; border-radius:8px }
    .wrap{ max-width:860px; margin: 16px auto; padding: 0 var(--pad) var(--pad); }
    .card{ background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.12); border-radius: var(--radius); padding: var(--pad); box-shadow: 0 16px 40px rgba(0,0,0,.35); }
    label{ display:block; font-size:.95rem; margin: 8px 0 4px; color:#fff }
    input, select, textarea{ width:100%; background: rgba(255,255,255,.12); color:#fff; border:1px solid rgba(255,255,255,.25); border-radius: 12px; padding: 12px; font-size: 1rem; outline: none; transition: background .2s, border-color .2s, box-shadow .2s; }
    select{ background-color:#3A003C; color:#fff; }
    option{ background-color:#3A003C; color:#fff; }
    input::placeholder, textarea::placeholder{ color:rgba(255,255,255,.65) }
    input:focus, select:focus, textarea:focus{ background: rgba(255,255,255,.18); border-color: var(--orange); box-shadow: 0 0 0 3px rgba(255,145,77,.25); }
    textarea{ min-height: 110px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px }
    .actions{ display:grid; grid-template-columns: 1fr auto; gap:10px; margin-top: 12px; align-items:center }
    .status{ justify-self:end; font-size:.85rem; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08) }
    .online{ color:#10b981 } .offline{ color:#fbbf24 }
    .btn{ padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.08); color:#fff; cursor:pointer; font-weight:600; transition: transform .06s ease, background .2s, border-color .2s; }
    .btn:hover{ background: rgba(255,255,255,.12) } .btn:active{ transform: translateY(1px) }
    .btn.primary{ background: var(--orange); border-color: var(--orange); color: #111; }
    .btn.ghost{ background:transparent; border:1px dashed rgba(255,255,255,.4); color:#fff }
    .tabs{ display:flex; gap:8px; margin: 12px 0 }
    .tab{ flex:1; text-align:center; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); color:#fff; cursor:pointer }
    .tab.active{ background: var(--orange); color: #111; border-color: var(--orange); font-weight:700 }
    .hidden{ display:none }
    .list{ margin-top:8px }
    .item{ background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:10px; margin:8px 0; cursor:pointer }
    .item .row{ display:flex; justify-content:space-between; align-items:center; gap:8px; color:#fff }
    .tiny{ color: rgba(255,255,255,.8); font-size:.85rem }
    .mono{ font-variant-numeric: tabular-nums }
    dialog{ border:none; border-radius:14px; background:#1b1120; color:#fff; padding:16px; width:min(860px,92vw) } dialog::backdrop{ background:rgba(0,0,0,.6) }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.5); color:#fff; font-size:.8rem }
    hr.sep{ border:none; border-top:1px dashed rgba(255,255,255,.2); margin:12px 0 }
    .footer{ text-align:center; color: rgba(255,255,255,.75); font-size:.85rem; margin-top:12px }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#065f46; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,.2); opacity:0; pointer-events:none; transition:opacity .2s }
    .toast.show{ opacity:1 } .toast.err{ background:#7f1d1d }
    .tools{ display:flex; gap:8px; justify-content:flex-end; margin:6px 0 0 }
    .searchRow{ display:flex; gap:8px; align-items:center; margin:8px 0 }
    .searchRow .searchBtn{ width:48px; height:48px; display:flex; align-items:center; justify-content:center; font-size:20px }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <img src="./icons/icon-192.png" alt="JulineMart logo">
      <div id="brand">JulineMart Vendor Sourcing</div>
    </div>
    <button id="settingsBtn" class="btn ghost">‚öôÔ∏è</button>
  </div>

  <div class="wrap">
    <div class="card">

      <div class="tabs">
        <div id="tabForm" class="tab active">Form</div>
        <div id="tabRecords" class="tab">My Records</div>
      </div>

      <!-- FORM -->
      <div id="viewForm">
        <div class="grid2">
          <div>
            <label>Marketer‚Äôs Name *</label>
            <input type="text" id="marketerName" required>
          </div>
          <div>
            <label>Marketer's Phone *</label>
            <input type="tel" id="marketerPhone" required>
          </div>
        </div>
        <label>Marketer Email (optional)</label>
        <input type="email" id="marketerEmail" placeholder="(Form auto-captures email; include here if needed)">

        <hr class="sep">

        <label>Vendor/Business Name *</label>
        <input type="text" id="vendorName" required>

        <div class="grid2">
          <div>
            <label>Contact Person Name *</label>
            <input type="text" id="contactPerson" required>
          </div>
          <div>
            <label>Vendor Phone Number *</label>
            <input type="tel" id="vendorPhone" required>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Vendor Email Address *</label>
            <input type="email" id="vendorEmail" required>
          </div>
          <div>
            <label>Business Address / Location *</label>
            <input type="text" id="businessAddress" required>
          </div>
        </div>

        <hr class="sep">

        <div class="grid3">
          <div>
            <label>Type of Business / Product Category *</label>
            <select id="category" required>
              <option value="">Select‚Ä¶</option>
              <option>Fashion</option>
              <option>Electronics</option>
              <option>Groceries</option>
              <option>Home and Living</option>
              <option>Beauty/Cosmetics</option>
              <option>Accessories</option>
              <option>Babies</option>
              <option>Automotives</option>
            </select>
          </div>
          <div>
            <label>Does the vendor currently sell online? *</label>
            <select id="sellsOnline" required>
              <option value="">Select‚Ä¶</option>
              <option>Yes</option>
              <option>No</option>
            </select>
          </div>
          <div>
            <label>If Yes, where?</label>
            <input type="text" id="whereOnline" placeholder="Instagram, Facebook, WhatsApp, Jumia, Konga, Physical shop only">
          </div>
        </div>

        <hr class="sep">

        <div class="grid3">
          <div>
            <label>Has the vendor shown interest in registering? *</label>
            <select id="interest" required>
              <option value="">Select‚Ä¶</option>
              <option>Yes</option>
              <option>No</option>
              <option>Maybe</option>
            </select>
          </div>
          <div>
            <label>Preferred onboarding method *</label>
            <select id="onboarding" required>
              <option value="">Select‚Ä¶</option>
              <option>Marketer Assistance</option>
              <option>Self Registration</option>
              <option>Needs Call Back</option>
            </select>
          </div>
          <div>
            <label>Any challenges/concerns raised by the vendor?</label>
            <input type="text" id="challenges" placeholder="Optional">
          </div>
        </div>

        <hr class="sep">

        <label>Upload product pictures (if available)</label>
        <input type="file" id="images" accept="image/*" multiple>

        <label>Marketer Comments</label>
        <textarea id="comments" placeholder="Anything else worth noting‚Ä¶"></textarea>

        <div class="actions">
          <button id="saveBtn" class="btn primary">‚ûï Save / Submit</button>
          <div id="netStatus" class="status">Status: <span class="online" id="onlineTxt">Online</span></div>
        </div>
      </div>

      <!-- RECORDS -->
      <div id="viewRecords" class="hidden">
        <div class="searchRow">
          <input type="text" id="fText" placeholder="Search vendor, staff, comments‚Ä¶" aria-label="Search records">
          <button id="doSearch" class="btn searchBtn" title="Search">üîé</button>
        </div>
        <div class="tools">
          <button id="syncNow" class="btn">‚ü≥ Sync queued now</button>
          <button id="exportCSV" class="btn">‚¨áÔ∏è Export My Records (CSV)</button>
        </div>
        <div id="list" class="list"></div>
      </div>

      <div class="footer">
  <a href="https://docs.google.com/spreadsheets/d/1Oy5sctouREFW7Sr84LQlkaXevX-LiYKYw_TdcEH6p3A/edit#gid=0"
     target="_blank" rel="noopener" class="tiny"
     style="color:#ff914d;text-decoration:underline">Open Sheet (Admin)</a>
  ‚Ä¢ Add to Home Screen on Android (‚ãÆ ‚Üí Add to Home screen) ‚Ä¢ iPhone Safari (Share ‚Üí Add to Home Screen).
  Works offline.
</div>
    </div>
  </div>

  <dialog id="settingsDlg">
    <form method="dialog">
      <h3 style="margin:0 0 10px;">Settings</h3>
      <label>Brand / Title
        <input id="brandInput" type="text" placeholder="JulineMart Vendor Sourcing">
      </label>
      <label>Default Marketer‚Äôs Name (auto-fill)
        <input id="defaultMarketerName" type="text" placeholder="e.g., John Doe">
      </label>
      <label>Default Marketer Phone (auto-fill)
        <input id="defaultMarketerPhone" type="tel" placeholder="e.g., 0803...">
      </label>
      <label>Default Marketer Email (auto-fill)
        <input id="defaultMarketerEmail" type="email" placeholder="e.g., staff@julinemart.com">
      </label>
      <label>Shared Token (must match your Apps Script TOKEN)
        <input id="tokenInput" type="text" placeholder="long-random-string">
      </label>
      <div class="tiny">Images are sent as base64 and stored in Drive if your Apps Script has a Drive folder ID set.</div>
      <div style="text-align:right; margin-top:10px;">
        <button value="cancel" class="btn">Cancel</button>
        <button id="saveSettingsBtn" value="default" class="btn primary">Save</button>
      </div>
    </form>
  </dialog>

  <dialog id="detailDlg">
    <form method="dialog">
      <h3 style="margin:0 0 10px;">Vendor entry (read-only)</h3>
      <div id="detailBody" class="tiny"></div>
      <div style="text-align:right; margin-top:10px;">
        <button value="cancel" class="btn">Close</button>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    function toast(msg, ok=true){ const t=document.getElementById('toast'); t.textContent=msg; t.className='toast show '+(ok?'':'err'); setTimeout(()=>{ t.className='toast'; }, 2000); }

    function setNet(){
      const s = document.getElementById('onlineTxt');
      if (navigator.onLine) { s.textContent='Online'; s.className='online'; }
      else { s.textContent='Offline'; s.className='offline'; }
    }
    window.addEventListener('online', setNet);
    window.addEventListener('offline', setNet);

    // CONFIG (no endpoint; baked in serverless function). Keep token for future rotations.
    const cfg = {
      get: ()=> ({
        brand: localStorage.getItem('jm:cfg:brand') || 'JulineMart Vendor Sourcing',
        token: localStorage.getItem('jm:cfg:token') || 'JMvSource_92nF7x!qA4pLz#Xt8Kd',
        defMarketerName: localStorage.getItem('jm:cfg:defMarketerName') || '',
        defMarketerPhone: localStorage.getItem('jm:cfg:defMarketerPhone') || '',
        defMarketerEmail: localStorage.getItem('jm:cfg:defMarketerEmail') || ''
      }),
      set: (o)=>{
        if (o.brand !== undefined) localStorage.setItem('jm:cfg:brand', o.brand);
        if (o.token !== undefined) localStorage.setItem('jm:cfg:token', o.token);
        if (o.defMarketerName !== undefined) localStorage.setItem('jm:cfg:defMarketerName', o.defMarketerName);
        if (o.defMarketerPhone !== undefined) localStorage.setItem('jm:cfg:defMarketerPhone', o.defMarketerPhone);
        if (o.defMarketerEmail !== undefined) localStorage.setItem('jm:cfg:defMarketerEmail', o.defMarketerEmail);
        applyBrand();
      }
    };
    function applyBrand(){ const c = cfg.get(); document.getElementById('brand').textContent = c.brand; document.title = c.brand; }

    const dataKey = (id)=> 'jm:data:'+id;
    const queueKey = 'jm:queue';
    function idNow(){ return new Date().toISOString(); }

    async function filesToBase64List(input){
      const files = Array.from(input.files || []);
      const out = [];
      for (const f of files){
        const buf = await f.arrayBuffer();
        const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
        out.push({ filename: f.name, mimeType: f.type || 'application/octet-stream', data: b64 });
      }
      return out;
    }

    function getPayload(){
      return {
        id: idNow(),
        marketerName: document.getElementById('marketerName').value.trim(),
        marketerPhone: document.getElementById('marketerPhone').value.trim(),
        marketerEmail: document.getElementById('marketerEmail').value.trim(),
        vendorName: document.getElementById('vendorName').value.trim(),
        contactPerson: document.getElementById('contactPerson').value.trim(),
        vendorPhone: document.getElementById('vendorPhone').value.trim(),
        vendorEmail: document.getElementById('vendorEmail').value.trim(),
        businessAddress: document.getElementById('businessAddress').value.trim(),
        category: document.getElementById('category').value,
        sellsOnline: document.getElementById('sellsOnline').value,
        whereOnline: document.getElementById('whereOnline').value.trim(),
        interest: document.getElementById('interest').value,
        onboarding: document.getElementById('onboarding').value,
        challenges: document.getElementById('challenges').value.trim(),
        comments: document.getElementById('comments').value.trim(),
        device: navigator.userAgent
      };
    }

    function validate(p){
      const req = [
        ['Marketer‚Äôs Name', p.marketerName],
        ['Marketer\'s Phone', p.marketerPhone],
        ['Vendor/Business Name', p.vendorName],
        ['Contact Person Name', p.contactPerson],
        ['Vendor Phone Number', p.vendorPhone],
        ['Vendor Email Address', p.vendorEmail],
        ['Business Address / Location', p.businessAddress],
        ['Type of Business / Product Category', p.category],
        ['Does the vendor currently sell online?', p.sellsOnline],
        ['Has the vendor shown interest in registering?', p.interest],
        ['Preferred onboarding method', p.onboarding]
      ];
      for (const [label, val] of req){
        if (!val){ alert('Please fill required field: '+label); return false; }
      }
      return true;
    }

    function saveLocal(p){ localStorage.setItem(dataKey(p.id), JSON.stringify(p)); }
    function allLocal(){
      return Object.keys(localStorage).filter(k=>k.startsWith('jm:data:')).map(k=>JSON.parse(localStorage.getItem(k)||'{}')).sort((a,b)=> a.id < b.id ? 1 : -1);
    }

    function queue(item){
      const q = JSON.parse(localStorage.getItem(queueKey) || '[]');
      q.push(item); localStorage.setItem(queueKey, JSON.stringify(q));
    }

    async function postViaProxy(payload, images){
      const { token } = cfg.get();
      if(!token) throw new Error('No token configured');
      const ctrl = new AbortController();
      const id = setTimeout(()=> ctrl.abort(), 20000);
      const res = await fetch('/.netlify/functions/gsheets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, ...payload, images }),
        signal: ctrl.signal
      });
      clearTimeout(id);
      if (!res.ok) {
        const text = await res.text().catch(()=>'');
        throw new Error('HTTP '+res.status+' '+text);
      }
      const j = await res.json().catch(()=>({ ok:false, error:'Invalid JSON from server' }));
      if (!j.ok) throw new Error(j.error || 'Sheets error');
      return j;
    }

    async function flushQueue(){
      const q = JSON.parse(localStorage.getItem(queueKey) || '[]');
      if(!q.length) return;
      const keep = [];
      for (const item of q){
        try { await postViaProxy(item.payload, item.images||[]); }
        catch(e){ keep.push(item); }
      }
      localStorage.setItem(queueKey, JSON.stringify(keep));
      toast(keep.length ? ('Some items still queued: '+keep.length) : 'All queued items synced ‚úì', keep.length===0);
      renderList();
    }
    window.addEventListener('online', flushQueue);

    function clearForm(){
      ['vendorName','contactPerson','vendorPhone','vendorEmail','businessAddress','whereOnline','challenges','comments'].forEach(id=> document.getElementById(id).value = '');
      ['category','sellsOnline','interest','onboarding'].forEach(id=> document.getElementById(id).value = '');
      document.getElementById('images').value = '';
      const c = cfg.get();
      if (c.defMarketerName) document.getElementById('marketerName').value = c.defMarketerName;
      if (c.defMarketerPhone) document.getElementById('marketerPhone').value = c.defMarketerPhone;
      if (c.defMarketerEmail) document.getElementById('marketerEmail').value = c.defMarketerEmail;
    }

    function renderList(){
      const list = document.getElementById('list');
      const t = (document.getElementById('fText').value || '').toLowerCase().trim();
      const items = allLocal().filter(p=>{
        if (!t) return true;
        const hay = [p.marketerName,p.vendorName,p.contactPerson,p.category,p.sellsOnline,p.whereOnline,p.challenges,p.comments].join(' ').toLowerCase();
        return hay.includes(t);
      });
      list.innerHTML = '';
      if(!items.length){
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = 'No records match your search.';
        list.appendChild(div);
        return;
      }
      items.forEach(p=>{
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="row">
            <div><strong>${p.vendorName}</strong>
              <div class="tiny">${p.category} ‚Ä¢ ${p.sellsOnline}${p.whereOnline? ' ('+p.whereOnline+')':''} ‚Ä¢ <span class="mono">${p.id.slice(0,10)}</span></div>
            </div>
            <div class="pill tiny">${p.interest}</div>
          </div>
          <div class="tiny" style="margin-top:6px;"><strong>Marketer:</strong> ${p.marketerName} ‚Ä¢ <strong>Contact:</strong> ${p.contactPerson}</div>
        `;
        div.addEventListener('click', ()=> showDetail(p));
        list.appendChild(div);
      });
    }

    function showDetail(p){
      const b = document.getElementById('detailBody');
      const esc = (s)=> String(s||'').replace(/</g,'&lt;');
      b.innerHTML = `
        <div><strong>ID:</strong> <span class="mono">${esc(p.id)}</span></div>
        <hr class="sep">
        <div><strong>Marketer:</strong> ${esc(p.marketerName)} ‚Ä¢ ${esc(p.marketerPhone)} ${p.marketerEmail? '‚Ä¢ '+esc(p.marketerEmail):''}</div>
        <div><strong>Vendor:</strong> ${esc(p.vendorName)}</div>
        <div><strong>Contact Person:</strong> ${esc(p.contactPerson)}</div>
        <div><strong>Phone / Email:</strong> ${esc(p.vendorPhone)} ‚Ä¢ ${esc(p.vendorEmail)}</div>
        <div><strong>Address:</strong> ${esc(p.businessAddress)}</div>
        <div><strong>Category:</strong> ${esc(p.category)}</div>
        <div><strong>Sells online:</strong> ${esc(p.sellsOnline)} ${p.whereOnline? '('+esc(p.whereOnline)+')':''}</div>
        <div><strong>Interest:</strong> ${esc(p.interest)} ‚Ä¢ <strong>Onboarding:</strong> ${esc(p.onboarding)}</div>
        ${p.challenges? `<div><strong>Challenges:</strong> ${esc(p.challenges)}</div>`:''}
        ${p.comments? `<div><strong>Marketer comments:</strong> ${esc(p.comments)}</div>`:''}
      `;
      document.getElementById('detailDlg').showModal();
    }

    function exportCSV(){
      const items = allLocal();
      const rows = [[
        'ID','Marketer‚Äôs Name','Marketer Phone','Marketer Email','Vendor/Business Name','Contact Person Name',
        'Vendor Phone','Vendor Email','Business Address','Category','Sells Online','Where',
        'Interest','Onboarding','Challenges','Comments'
      ]];
      items.forEach(p=> rows.push([p.id,p.marketerName,p.marketerPhone,p.marketerEmail,p.vendorName,p.contactPerson,p.vendorPhone,p.vendorEmail,p.businessAddress,p.category,p.sellsOnline,p.whereOnline,p.interest,p.onboarding,(p.challenges||'').replace(/\n/g,' '),(p.comments||'').replace(/\n/g,' ')]));
      const csv = rows.map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'jm-sourcing-records.csv';
      document.body.appendChild(a); a.click(); a.remove();
    }

    document.getElementById('saveBtn').addEventListener('click', async (ev)=>{
      const btn = ev.currentTarget;
      const payload = getPayload();
      if (!validate(payload)) return;
      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = 'Saving‚Ä¶';
      saveLocal(payload);
      const images = await filesToBase64List(document.getElementById('images'));
      try {
        await postViaProxy(payload, images);
        toast('Saved and synced ‚úì', true);
        btn.textContent = 'Saved ‚úì';
        setTimeout(()=> btn.textContent = original, 900);
      } catch (e) {
        queue({ payload, images });
        console.error('Sync failed:', e);
        toast('Saved locally. ' + e.message, false);
        btn.textContent = 'Queued ‚ü≥';
        setTimeout(()=> btn.textContent = original, 1400);
      } finally {
        btn.disabled = false;
      }
      renderList();
    });
    document.getElementById('exportCSV').addEventListener('click', exportCSV);
    document.getElementById('syncNow').addEventListener('click', (e)=>{ e.preventDefault(); flushQueue(); });

    const tabForm = document.getElementById('tabForm');
    const tabRecords = document.getElementById('tabRecords');
    const viewForm = document.getElementById('viewForm');
    const viewRecords = document.getElementById('viewRecords');
    function showTab(which){
      if (which === 'records'){
        tabForm.classList.remove('active'); tabRecords.classList.add('active');
        viewForm.classList.add('hidden'); viewRecords.classList.remove('hidden'); renderList();
      } else {
        tabRecords.classList.remove('active'); tabForm.classList.add('active');
        viewRecords.classList.add('hidden'); viewForm.classList.remove('hidden');
      }
    }
    tabForm.addEventListener('click', ()=> showTab('form'));
    tabRecords.addEventListener('click', ()=> showTab('records'));

    const settingsDlg = document.getElementById('settingsDlg');
    document.getElementById('settingsBtn').addEventListener('click', ()=>{
      const c = cfg.get();
      document.getElementById('brandInput').value = c.brand;
      document.getElementById('tokenInput').value = c.token;
      document.getElementById('defaultMarketerName').value = c.defMarketerName;
      document.getElementById('defaultMarketerPhone').value = c.defMarketerPhone;
      document.getElementById('defaultMarketerEmail').value = c.defMarketerEmail;
      settingsDlg.showModal();
    });
    document.getElementById('saveSettingsBtn').addEventListener('click', (e)=>{
      e.preventDefault();
      cfg.set({
        brand: document.getElementById('brandInput').value.trim() || 'JulineMart Vendor Sourcing',
        token: document.getElementById('tokenInput').value.trim() || 'JMvSource_92nF7x!qA4pLz#Xt8Kd',
        defMarketerName: document.getElementById('defaultMarketerName').value.trim(),
        defMarketerPhone: document.getElementById('defaultMarketerPhone').value.trim(),
        defMarketerEmail: document.getElementById('defaultMarketerEmail').value.trim(),
      });
      settingsDlg.close();
      const c = cfg.get();
      if (c.defMarketerName) document.getElementById('marketerName').value = c.defMarketerName;
      if (c.defMarketerPhone) document.getElementById('marketerPhone').value = c.defMarketerPhone;
      if (c.defMarketerEmail) document.getElementById('marketerEmail').value = c.defMarketerEmail;
      flushQueue();
    });

    function init(){
      applyBrand();
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js'));
      }
      if (!localStorage.getItem('jm:cfg:token')) localStorage.setItem('jm:cfg:token', 'JMvSource_92nF7x!qA4pLz#Xt8Kd');
      setNet();
      const c = cfg.get();
      if (c.defMarketerName) document.getElementById('marketerName').value = c.defMarketerName;
      if (c.defMarketerPhone) document.getElementById('marketerPhone').value = c.defMarketerPhone;
      if (c.defMarketerEmail) document.getElementById('marketerEmail').value = c.defMarketerEmail;
      renderList();
      flushQueue();
    }
    init();

    document.getElementById('fText').addEventListener('input', renderList);
    document.getElementById('doSearch').addEventListener('click', (e)=>{ e.preventDefault(); renderList(); });
  </script>
</body>
</html>
