<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JulineMart Vendor Sourcing</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#5E0063">
  <style>
    :root { --purple:#5E0063; --purple-dark:#3A003C; --purple-darker:#240025; --orange:#ff914d; --ink:#f9fafb; }
    *{ box-sizing:border-box }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0;
          background: radial-gradient(1200px 700px at 20% -10%, var(--purple) 0%, var(--purple-dark) 45%, var(--purple-darker) 100%);
          color:var(--ink); }
    .topbar{ background:rgba(255,255,255,.06); backdrop-filter: blur(8px); color:#fff; padding:10px 14px; display:flex; align-items:center; gap:12px; position: sticky; top: 0; z-index: 10; border-bottom:1px solid rgba(255,255,255,.08); }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800 }
    .brand img{ width:36px; height:36px; border-radius:8px }
    .actionsRight { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .wrap{ max-width:860px; margin: 16px auto; padding: 0 14px 14px; }
    .card{ background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.12); border-radius: 14px; padding: 14px; box-shadow: 0 16px 40px rgba(0,0,0,.35); }
    label{ display:block; font-size:.95rem; margin: 8px 0 4px; color:#fff }
    input, select, textarea{ width:100%; background: rgba(255,255,255,.12); color:#fff; border:1px solid rgba(255,255,255,.25); border-radius: 12px; padding: 12px; font-size: 1rem; outline: none; transition: background .2s, border-color .2s, box-shadow .2s; }
    select, option{ background-color:#3A003C; color:#fff; }
    input::placeholder, textarea::placeholder{ color:rgba(255,255,255,.65) }
    input:focus, select:focus, textarea:focus{ background: rgba(255,255,255,.18); border-color: var(--orange); box-shadow: 0 0 0 3px rgba(255,145,77,.25); }
    textarea{ min-height: 110px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px }
    .actions{ display:grid; grid-template-columns: 1fr auto; gap:10px; margin-top: 12px; align-items:center }
    .status{ justify-self:end; font-size:.85rem; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08) }
    .online{ color:#10b981 } .offline{ color:#fbbf24 }
    .btn{ padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.25); background: rgba(255,255,255,.08); color:#fff; cursor:pointer; font-weight:600; transition: transform .06s ease, background .2s, border-color .2s; }
    .btn:hover{ background: rgba(255,255,255,.12) } .btn:active{ transform: translateY(1px) }
    .btn.primary{ background: var(--orange); border-color: var(--orange); color: #111; }
    .btn.ghost{ background:transparent; border:1px dashed rgba(255,255,255,.4); color:#fff }
    .tabs{ display:flex; gap:8px; margin: 12px 0 }
    .tab{ flex:1; text-align:center; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); color:#fff; cursor:pointer }
    .tab.active{ background: var(--orange); color: #111; border-color: var(--orange); font-weight:700 }
    .hidden{ display:none }
    .list{ margin-top:8px }
    .item{ background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); border-radius:12px; padding:10px; margin:8px 0; cursor:pointer }
    .item .row{ display:flex; justify-content:space-between; align-items:center; gap:8px; color:#fff }
    .tiny{ color: rgba(255,255,255,.8); font-size:.85rem }
    .mono{ font-variant-numeric: tabular-nums }
    dialog{ border:none; border-radius:14px; background:#1b1120; color:#fff; padding:16px; width:min(860px,92vw) } dialog::backdrop{ background:rgba(0,0,0,.6) }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.5); color:#fff; font-size:.8rem }
    hr.sep{ border:none; border-top:1px dashed rgba(255,255,255,.2); margin:12px 0 }
    .footer{ text-align:center; color: rgba(255,255,255,.75); font-size:.9rem; margin-top:12px }
    .searchRow{ display:flex; gap:8px; align-items:center; margin:8px 0 }
    .searchRow .searchBtn{ width:48px; height:48px; display:flex; align-items:center; justify-content:center; font-size:20px }
    .toast{ position:fixed; left:50%; bottom:20px; transform:translateX(-50%); background:rgba(0,0,0,.8); color:#fff; padding:10px 14px; border-radius:10px; opacity:0; pointer-events:none; transition:opacity .25s; z-index:100 }
    .toast.show{ opacity:1 }
    .toast.err{ background:#7a1320 }
  </style>
</head>
<body>
<div class="topbar">
  <div class="brand">
    <img src="./icons/icon-192.png" alt="JulineMart logo">
    ':'');
  document.getElementById('detailDlg').showModal();
}

// Save / Submit
document.getElementById('saveBtn').addEventListener('click', async function(ev){
  const btn = ev.currentTarget;
  const payload = getPayload();
  if (!validate(payload)) return;
  btn.disabled = true; const original = btn.textContent; btn.textContent = 'Saving…';
  saveLocal(payload);
  const images = await filesToBase64List(document.getElementById('images'));
  try { await postViaProxy(payload); toast('Saved and synced ✓', true); btn.textContent = 'Saved ✓'; setTimeout(function(){ btn.textContent = original; }, 900); }
  catch (e){ queue({ payload: payload: images }); console.error('Sync failed:', e); toast('Saved locally. ' + e.message, false); btn.textContent = 'Queued ⟳'; setTimeout(function(){ btn.textContent = original; }, 1400); }
  finally { btn.disabled = false; }
  renderList();
});

// Records tools
document.getElementById('exportCSV').addEventListener('click', function(){
  const items = allLocal();
  const rows = [[
    "ID","Marketer's Name","Marketer Phone","Marketer Email","Vendor/Business Name","Contact Person Name",
    "Vendor Phone","Vendor Email","Business Address","Category","Sells Online","Where",
    "Interest","Onboarding","Challenges","Comments","Device"
  ]];
  items.forEach(function(p){
    rows.push([p.id,p.marketerName,p.marketerPhone,p.marketerEmail,p.vendorName,p.contactPerson,p.vendorPhone,p.vendorEmail,p.businessAddress,p.category,p.sellsOnline,p.whereOnline,p.interest,p.onboarding,(p.challenges||'').replace(/\n/g,' '),(p.comments||'').replace(/\n/g,' '),p.device]);
  });
  const csv = rows.map(function(r){ return r.map(function(v){ return '"' + String(v).replace(/"/g,'""') + '"'; }).join(','); }).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'jm-sourcing-records.csv'; document.body.appendChild(a); a.click(); a.remove();
});

document.getElementById('syncNow').addEventListener('click', function(e){ e.preventDefault(); flushQueue(); });
document.getElementById('fText').addEventListener('input', renderList);
document.getElementById('doSearch').addEventListener('click', function(e){ e.preventDefault(); renderList(); });

// Select / Delete selected
document.getElementById('toggleSelect').addEventListener('click', function(){
  selectMode = !selectMode; selectedIds.clear();
  document.getElementById('toggleSelect').textContent = selectMode ? 'Done selecting' : '☑️ Select';
  renderList();
});

document.getElementById('deleteSelected').addEventListener('click', async function(){
  if (!selectedIds.size) { alert('No entries selected.'); return; }
  const pin = prompt('Enter Admin PIN to delete selected rows:'); if (!pin) return;
  const ids = Array.from(selectedIds);
  const token = (localStorage.getItem('jm:cfg:token') || 'JMvSource_92nF7x!qA4pLz#Xt8Kd').trim();
  try {
    const res = await fetch('/.netlify/functions/vendor-intake', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, ...payload })
    });
    const j = await res.json().catch(function(){ return { ok:false, error:'Invalid JSON' }; });
    if (!j.ok) throw new Error(j.error || 'Delete failed');
    ids.forEach(function(id){ localStorage.removeItem('jm:data:'+id); });
    alert('Deleted ' + (j.deleted || 0) + ' row(s).');
    selectedIds.clear(); selectMode = false; document.getElementById('toggleSelect').textContent = '☑️ Select';
    renderList();
  } catch (err) { alert('Delete error: ' + (err.message || err)); }
});

// Admin dialog (single delete)
document.getElementById('adminBtn').addEventListener('click', function(){ document.getElementById('adminDlg').showModal(); });
document.getElementById('adminDeleteBtn').addEventListener('click', async function(e){
  e.preventDefault();
  const id = document.getElementById('adminDeleteId').value.trim();
  const pin = document.getElementById('adminPin').value.trim();
  if (!id || !pin) { alert('Please enter EntryID and Admin PIN.'); return; }
  const token = (localStorage.getItem('jm:cfg:token') || 'JMvSource_92nF7x!qA4pLz#Xt8Kd').trim();
  try {
    const res = await fetch('/.netlify/functions/vendor-intake', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, ...payload })
    });
    const j = await res.json().catch(function(){ return { ok:false, error:'Invalid JSON' }; });
    if (!j.ok) throw new Error(j.error || 'Delete failed');
    localStorage.removeItem('jm:data:'+id);
    alert('Deleted ' + (j.deleted || 0) + ' row(s).');
    document.getElementById('adminDlg').close(); renderList();
  } catch (err) { alert('Delete error: ' + (err.message || err)); }
});

// Settings
const settingsDlg = document.getElementById('settingsDlg');
document.getElementById('settingsBtn').addEventListener('click', function(){
  const c = cfg.get();
  document.getElementById('brandInput').value = c.brand;
  document.getElementById('tokenInput').value = c.token;
  document.getElementById('defaultMarketerName').value = c.defMarketerName;
  document.getElementById('defaultMarketerPhone').value = c.defMarketerPhone;
  document.getElementById('defaultMarketerEmail').value = c.defMarketerEmail;
  settingsDlg.showModal();
});
document.getElementById('saveSettingsBtn').addEventListener('click', function(e){
  e.preventDefault();
  cfg.set({
    brand: document.getElementById('brandInput').value.trim() || 'JulineMart Vendor Sourcing',
    token: document.getElementById('tokenInput').value.trim() || 'JMvSource_92nF7x!qA4pLz#Xt8Kd',
    defMarketerName: document.getElementById('defaultMarketerName').value.trim(),
    defMarketerPhone: document.getElementById('defaultMarketerPhone').value.trim(),
    defMarketerEmail: document.getElementById('defaultMarketerEmail').value.trim(),
  });
  settingsDlg.close();
  const c = cfg.get();
  if (c.defMarketerName) document.getElementById('marketerName').value = c.defMarketerName;
  if (c.defMarketerPhone) document.getElementById('marketerPhone').value = c.defMarketerPhone;
  if (c.defMarketerEmail) document.getElementById('marketerEmail').value = c.defMarketerEmail;
  flushQueue();
});

// Tabs + init
const tabForm = document.getElementById('tabForm');
const tabRecords = document.getElementById('tabRecords');
const viewForm = document.getElementById('viewForm');
const viewRecords = document.getElementById('viewRecords');
function showTab(which){
  if (which === 'records'){ tabForm.classList.remove('active'); tabRecords.classList.add('active'); viewForm.classList.add('hidden'); viewRecords.classList.remove('hidden'); renderList(); }
  else { tabRecords.classList.remove('active'); tabForm.classList.add('active'); viewRecords.classList.add('hidden'); viewForm.classList.remove('hidden'); }
}
tabForm.addEventListener('click', function(){ showTab('form'); });
tabRecords.addEventListener('click', function(){ showTab('records'); });

function init(){
  applyBrand();
  if ('serviceWorker' in navigator) { window.addEventListener('load', function(){ navigator.serviceWorker.register('./service-worker.js'); }); }
  if (!localStorage.getItem('jm:cfg:token')) localStorage.setItem('jm:cfg:token', 'JMvSource_92nF7x!qA4pLz#Xt8Kd');
  setNet();
  const c = cfg.get();
  if (c.defMarketerName) document.getElementById('marketerName').value = c.defMarketerName;
  if (c.defMarketerPhone) document.getElementById('marketerPhone').value = c.defMarketerPhone;
  if (c.defMarketerEmail) document.getElementById('marketerEmail').value = c.defMarketerEmail;
  renderList(); flushQueue();
}
init();
</script>
</body>
</html>
